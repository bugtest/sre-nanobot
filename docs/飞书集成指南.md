# é£ä¹¦é›†æˆæŒ‡å—

> å®ç°å‘Šè­¦é€šçŸ¥ã€å®¡æ‰¹è¯·æ±‚ã€æ•…éšœæŠ¥å‘Šç­‰åŠŸèƒ½

---

## ğŸ“‹ å‰ç½®è¦æ±‚

- é£ä¹¦ä¼ä¸šç®¡ç†å‘˜æƒé™
- å·²åˆ›å»ºé£ä¹¦ç¾¤èŠ
- å¯ä»¥åˆ›å»ºé£ä¹¦æœºå™¨äºº

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤ 1: åˆ›å»ºé£ä¹¦æœºå™¨äºº

1. **è¿›å…¥é£ä¹¦ç¾¤è®¾ç½®**
   - æ‰“å¼€é£ä¹¦ç¾¤èŠ
   - ç‚¹å‡»å³ä¸Šè§’è®¾ç½®å›¾æ ‡
   - é€‰æ‹© "ç¾¤æœºå™¨äºº"

2. **æ·»åŠ æœºå™¨äºº**
   - ç‚¹å‡» "æ·»åŠ æœºå™¨äºº"
   - é€‰æ‹© "è‡ªå®šä¹‰æœºå™¨äºº"
   - è¾“å…¥æœºå™¨äººåç§°ï¼š`SRE-NanoBot`
   - é€‰æ‹©æœºå™¨äººå¤´åƒ

3. **è·å– Webhook URL**
   - å¤åˆ¶ Webhook åœ°å€ï¼ˆæ ¼å¼ï¼š`https://open.feishu.cn/open-apis/bot/v2/hook/xxx`ï¼‰
   - å¯é€‰ï¼šå¼€å¯ "è‡ªå®šä¹‰å…³é”®è¯"ï¼ˆæ¨èæ·»åŠ  "å‘Šè­¦"ã€"è¿ç»´" ç­‰å…³é”®è¯ï¼‰
   - å¯é€‰ï¼šå¼€å¯ "ç­¾åæ ¡éªŒ"ï¼ˆæ›´å®‰å…¨ï¼‰

4. **ä¿å­˜é…ç½®**
   - ç‚¹å‡» "å®Œæˆ"
   - æœºå™¨äººåˆ›å»ºæˆåŠŸ

---

### æ­¥éª¤ 2: é…ç½® SRE-NanoBot

ç¼–è¾‘é…ç½®æ–‡ä»¶ `~/.nanobot/config.json`ï¼š

```json
{
  "integrations": {
    "feishu": {
      "enabled": true,
      "webhook_url": "https://open.feishu.cn/open-apis/bot/v2/hook/xxx",
      "secret": "å¯é€‰çš„ç­¾åå¯†é’¥",
      "channels": {
        "alert": "å‘Šè­¦é€šçŸ¥ç¾¤ ID",
        "approval": "å®¡æ‰¹é€šçŸ¥ç¾¤ ID",
        "report": "æ—¥æŠ¥ç¾¤ ID"
      }
    }
  }
}
```

---

### æ­¥éª¤ 3: æµ‹è¯•é€šçŸ¥

```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬
python tests/test_feishu.py
```

**é¢„æœŸè¾“å‡ºï¼š**
```
âœ… é£ä¹¦é€šçŸ¥å™¨åˆå§‹åŒ–æˆåŠŸ
âœ… æµ‹è¯•æ¶ˆæ¯å‘é€æˆåŠŸ
âœ… å‘Šè­¦å¡ç‰‡å‘é€æˆåŠŸ
âœ… å®¡æ‰¹è¯·æ±‚å‘é€æˆåŠŸ
```

---

## ğŸ“± æ¶ˆæ¯ç±»å‹

### 1. å‘Šè­¦é€šçŸ¥

**è§¦å‘åœºæ™¯ï¼š**
- Prometheus å‘Šè­¦è§¦å‘
- æœåŠ¡å¼‚å¸¸æ£€æµ‹
- èµ„æºé˜ˆå€¼å‘Šè­¦

**æ¶ˆæ¯ç¤ºä¾‹ï¼š**
```
ğŸš¨ PodCrashLooping

å‘Šè­¦çº§åˆ«ï¼šP1
çŠ¶æ€ï¼šfiring
æ—¶é—´ï¼š2026-02-27 08:00:00

æè¿°ï¼šPod é‡å¯æ¬¡æ•°è¶…è¿‡ 5 æ¬¡
å½±å“æœåŠ¡ï¼šapi-service

[æŸ¥çœ‹è¯¦æƒ…] [ç¡®è®¤å‘Šè­¦]
```

**é…ç½®ï¼š**
```yaml
alert_notification:
  enabled: true
  severity_filter: ["P0", "P1", "P2"]  # P3 ä¸é€šçŸ¥
  mention_on_p0: true                   # P0 å‘Šè­¦@æ‰€æœ‰äºº
```

---

### 2. å®¡æ‰¹è¯·æ±‚

**è§¦å‘åœºæ™¯ï¼š**
- ç”Ÿäº§ç¯å¢ƒé‡å¯
- å¤§è§„æ¨¡æ‰©ç¼©å®¹
- æ•°æ®åº“æ“ä½œ

**æ¶ˆæ¯ç¤ºä¾‹ï¼š**
```
ğŸ” è¿ç»´æ“ä½œå®¡æ‰¹è¯·æ±‚

æ“ä½œç±»å‹ï¼šPod é‡å¯
æ‰§è¡Œ Agent: AutoFix
é£é™©ç­‰çº§ï¼šmedium

è¯¦ç»†ä¿¡æ¯ï¼š
é‡å¯ production/api-service

å½±å“èŒƒå›´ï¼šapi-service æœåŠ¡
é¢„è®¡æ—¶é—´ï¼š3-5 åˆ†é’Ÿ

[âœ… æ‰¹å‡†] [âŒ æ‹’ç»] [ğŸ’¬ è¯„è®º]

å®¡æ‰¹è¶…æ—¶æ—¶é—´ï¼š300 ç§’
```

**é…ç½®ï¼š**
```yaml
approval_notification:
  enabled: true
  require_approval_for:
    - production_restart
    - scale_above_10
    - database_operation
  timeout: 300  # 5 åˆ†é’Ÿè¶…æ—¶
```

---

### 3. æ•…éšœæŠ¥å‘Š

**è§¦å‘åœºæ™¯ï¼š**
- æ•…éšœå¤„ç†å®Œæˆ
- è‡ªåŠ¨ç”Ÿæˆæ•…éšœæŠ¥å‘Š

**æ¶ˆæ¯ç¤ºä¾‹ï¼š**
```
ğŸ“‹ æ•…éšœå¤„ç†æŠ¥å‘Š

æ•…éšœ ID: INC-2026-02-27-001
ä¸¥é‡çº§åˆ«ï¼šP1
çŠ¶æ€ï¼šresolved

æ‘˜è¦ï¼šå‘ç”Ÿèµ„æºè€—å°½ï¼Œå½±å“ 1 ä¸ªæœåŠ¡
æ ¹å› ï¼šå†…å­˜é™åˆ¶è¿‡ä½å¯¼è‡´ OOM

å½±å“æœåŠ¡ï¼šapi-service
æŒç»­æ—¶é—´ï¼š6 åˆ†é’Ÿ
ç”¨æˆ·å½±å“ï¼š10%

å¤„ç†è¿‡ç¨‹ï¼š
14:00 å‘Šè­¦è§¦å‘
14:01 å¼€å§‹åˆ†æ
14:03 æ‰§è¡Œé‡å¯
14:06 éªŒè¯æ¢å¤

åç»­æ”¹è¿›ï¼š
1. å¢åŠ å†…å­˜é™åˆ¶
2. æ·»åŠ å†…å­˜ç›‘æ§å‘Šè­¦
```

**é…ç½®ï¼š**
```yaml
incident_report:
  enabled: true
  send_on_resolve: true
  include_timeline: true
  include_action_items: true
```

---

### 4. æ—¥å¸¸æŠ¥å‘Š

**è§¦å‘åœºæ™¯ï¼š**
- æ¯æ—¥å®šæ—¶å‘é€
- è¿ç»´æ—¥æŠ¥

**æ¶ˆæ¯ç¤ºä¾‹ï¼š**
```
ğŸ“Š SRE æ—¥æŠ¥

æ—¥æœŸï¼š2026-02-27
å€¼ç­ï¼šå¼ ä¸‰

å‘Šè­¦ç»Ÿè®¡:
â€¢ P0 å‘Šè­¦ï¼š0
â€¢ P1 å‘Šè­¦ï¼š2
â€¢ P2 å‘Šè­¦ï¼š5
â€¢ è‡ªåŠ¨ä¿®å¤ï¼š3

ç³»ç»Ÿå¯ç”¨æ€§ï¼š99.9%
å¹³å‡å“åº”æ—¶é—´ï¼š50ms
é”™è¯¯ç‡ï¼š0.1%

ä»Šæ—¥å˜æ›´:
- api-service v1.2.3 å‘å¸ƒ
- æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–

å¾…åŠäº‹é¡¹:
- å®¡æŸ¥ P1 å‘Šè­¦æ ¹å› 
- æ›´æ–°æ‰©å®¹é¢„æ¡ˆ
```

**é…ç½®ï¼š**
```yaml
daily_report:
  enabled: true
  schedule: "0 20 * * *"  # æ¯å¤© 20:00
  recipients: ["è¿ç»´ç¾¤"]
  include_metrics: true
```

---

## ğŸ”§ é«˜çº§é…ç½®

### åˆ†çº§é€šçŸ¥ç­–ç•¥

```yaml
notification_policy:
  P0:
    channels: ["phone", "feishu", "sms"]
    mention: ["@all", "@oncall"]
    escalation_timeout: 300  # 5 åˆ†é’Ÿæœªå“åº”å‡çº§
  P1:
    channels: ["feishu"]
    mention: ["@oncall"]
    escalation_timeout: 900  # 15 åˆ†é’Ÿæœªå“åº”å‡çº§
  P2:
    channels: ["feishu"]
    mention: []
  P3:
    channels: ["log"]  # ä»…è®°å½•
```

### å®¡æ‰¹æµç¨‹é…ç½®

```yaml
approval_workflow:
  levels:
    L1:  # ä¸€çº§å®¡æ‰¹
      approvers: ["å€¼ç­äººå‘˜"]
      timeout: 300
      auto_approve_on_timeout: false
    L2:  # äºŒçº§å®¡æ‰¹
      approvers: ["æŠ€æœ¯è´Ÿè´£äºº"]
      timeout: 600
      auto_approve_on_timeout: true
    L3:  # ä¸‰çº§å®¡æ‰¹
      approvers: ["è¿ç»´æ€»ç›‘"]
      timeout: 900
      auto_approve_on_timeout: false
  
  operations:
    pod_restart: L1
    deployment_rollback: L2
    database_failover: L3
```

### å‘Šè­¦è¿‡æ»¤

```yaml
alert_filter:
  # å¿½ç•¥çš„å‘Šè­¦
  ignore_alerts:
    - "TestAlert"
    - "HeartbeatFailed"
  
  # é™é»˜æ—¶æ®µ
  silence_periods:
    - name: "ç»´æŠ¤çª—å£"
      schedule: "0 2-4 * * 0"  # å‘¨æ—¥ 2-4 ç‚¹
      alerts: ["*"]
  
  # å‘Šè­¦èšåˆ
  aggregation:
    enabled: true
    window: 300  # 5 åˆ†é’Ÿçª—å£
    group_by: ["alertname", "service"]
```

---

## ğŸ“Š æ¶ˆæ¯å¡ç‰‡æ¨¡æ¿

### å‘Šè­¦å¡ç‰‡æ¨¡æ¿

```json
{
  "header": {
    "title": {"tag": "plain_text", "content": "ğŸš¨ å‘Šè­¦åç§°"},
    "template": "red"
  },
  "elements": [
    {"tag": "div", "text": {"tag": "lark_md", "content": "**çº§åˆ«**: P1"}},
    {"tag": "hr"},
    {"tag": "div", "text": {"tag": "lark_md", "content": "**æè¿°**: è¯¦ç»†æè¿°"}},
    {"tag": "action", "actions": [
      {"tag": "button", "text": {"content": "æŸ¥çœ‹è¯¦æƒ…"}, "type": "primary"}
    ]}
  ]
}
```

### å®¡æ‰¹å¡ç‰‡æ¨¡æ¿

```json
{
  "header": {
    "title": {"tag": "plain_text", "content": "ğŸ” å®¡æ‰¹è¯·æ±‚"},
    "template": "blue"
  },
  "elements": [
    {"tag": "div", "text": {"tag": "lark_md", "content": "**æ“ä½œ**: é‡å¯"}},
    {"tag": "hr"},
    {"tag": "action", "actions": [
      {"tag": "button", "text": {"content": "âœ… æ‰¹å‡†"}, "type": "primary"},
      {"tag": "button", "text": {"content": "âŒ æ‹’ç»"}, "type": "danger"}
    ]}
  ]
}
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æ¶ˆæ¯å‘é€å¤±è´¥

**é”™è¯¯ï¼š** `400 Bad Request`

**è§£å†³ï¼š**
1. æ£€æŸ¥ Webhook URL æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥ç­¾åå¯†é’¥æ˜¯å¦åŒ¹é…
3. æ£€æŸ¥æ¶ˆæ¯æ ¼å¼æ˜¯å¦ç¬¦åˆé£ä¹¦è§„èŒƒ

### é—®é¢˜ 2: æ”¶ä¸åˆ°é€šçŸ¥

**å¯èƒ½åŸå› ï¼š**
1. æœºå™¨äººè¢«ç¦ç”¨
2. å…³é”®è¯ä¸åŒ¹é…
3. ç¾¤è®¾ç½®é™åˆ¶

**è§£å†³ï¼š**
1. æ£€æŸ¥æœºå™¨äººçŠ¶æ€
2. è°ƒæ•´å…³é”®è¯é…ç½®
3. æ£€æŸ¥ç¾¤æ¶ˆæ¯è®¾ç½®

### é—®é¢˜ 3: å¡ç‰‡æ˜¾ç¤ºå¼‚å¸¸

**å¯èƒ½åŸå› ï¼š**
1. JSON æ ¼å¼é”™è¯¯
2. å­—æ®µç±»å‹ä¸æ­£ç¡®
3. ä½¿ç”¨äº†ä¸æ”¯æŒçš„æ ‡ç­¾

**è§£å†³ï¼š**
1. ä½¿ç”¨ JSON éªŒè¯å·¥å…·æ£€æŸ¥æ ¼å¼
2. å‚è€ƒé£ä¹¦å®˜æ–¹æ–‡æ¡£
3. ä½¿ç”¨å®˜æ–¹å¡ç‰‡åˆ›å»ºå·¥å…·

---

## ğŸ“ API å‚è€ƒ

### FeishuNotifier ç±»

```python
class FeishuNotifier:
    def __init__(self, webhook_url: str, secret: Optional[str] = None)
    
    # åŸºç¡€æ¶ˆæ¯
    async def send_message(content: Dict, msg_type: str = "interactive") -> bool
    async def send_text(text: str, mentioned: List[str] = None) -> bool
    async def send_post(title: str, content: List) -> bool
    async def send_interactive(card: Dict) -> bool
    
    # ä¸šåŠ¡æ¶ˆæ¯
    async def send_alert_notification(alert: Dict) -> bool
    async def send_approval_request(approval: Dict) -> bool
    async def send_incident_report(incident: Dict) -> bool
    async def send_daily_report(report: Dict) -> bool
```

### ä½¿ç”¨ç¤ºä¾‹

```python
from sre_nanobot.integrations.feishu_notifier import FeishuNotifier

# åˆ›å»ºé€šçŸ¥å™¨
notifier = FeishuNotifier(
    webhook_url="https://open.feishu.cn/open-apis/bot/v2/hook/xxx",
    secret="your-secret"
)

# å‘é€å‘Šè­¦
await notifier.send_alert_notification({
    "name": "PodCrashLooping",
    "severity": "P1",
    "status": "firing",
    "description": "Pod é‡å¯æ¬¡æ•°è¿‡å¤š",
    "affected_services": ["api-service"]
})

# å‘é€å®¡æ‰¹
await notifier.send_approval_request({
    "operation": "Pod é‡å¯",
    "risk_level": "medium",
    "details": "é‡å¯ production/api-service",
    "timeout": 300
})

# å…³é—­è¿æ¥
await notifier.close()
```

---

## ğŸ“š å‚è€ƒèµ„æº

- [é£ä¹¦å¼€æ”¾å¹³å°](https://open.feishu.cn/document/)
- [æœºå™¨äººå¼€å‘æ–‡æ¡£](https://open.feishu.cn/document/ukTMukTMukTM/ucTM5YjL3ETO24yNxkjN)
- [æ¶ˆæ¯å¡ç‰‡æ–‡æ¡£](https://open.feishu.cn/document/ukTMukTMukTM/uUjNz4SN2YjL1IzM)
- [å¡ç‰‡åˆ›å»ºå·¥å…·](https://open.feishu.cn/tool/cardbuilder)

---

*æœ€åæ›´æ–°ï¼š2026-02-27*
