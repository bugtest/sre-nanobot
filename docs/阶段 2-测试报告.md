# é˜¶æ®µ 2 æµ‹è¯•æŠ¥å‘Š

> æµ‹è¯•æ—¶é—´ï¼š2026-02-27

---

## âœ… æµ‹è¯•ç»“æœ

**çŠ¶æ€ï¼šé€šè¿‡ âœ…**

| ç±»åˆ« | é€šè¿‡ | å¤±è´¥ | è­¦å‘Š |
|------|------|------|------|
| æ•°é‡ | 29 | 0 | 3 |

---

## ğŸ“‹ è¯¦ç»†æµ‹è¯•

### 1. æ–‡ä»¶å®Œæ•´æ€§ âœ…

```
âœ… prometheus_server.py (785 è¡Œ)
âœ… monitor_agent.py (340 è¡Œ)
âœ… alertmanager_webhook.py (207 è¡Œ)
```

**ç»“è®ºï¼š** æ‰€æœ‰æ–‡ä»¶å®Œæ•´

---

### 2. è¯­æ³•æ£€æŸ¥ âœ…

```
âœ… prometheus_server.py è¯­æ³•æ­£ç¡®
âœ… monitor_agent.py è¯­æ³•æ­£ç¡®
âœ… alertmanager_webhook.py è¯­æ³•æ­£ç¡®
```

**ç»“è®ºï¼š** ä»£ç è¯­æ³•æ— é”™è¯¯

---

### 3. å¯¼å…¥æµ‹è¯• âš ï¸

```
âš ï¸  Prometheus MCP éœ€è¦ httpx åº“
âœ… Prometheus MCP ä»£ç ç»“æ„æ­£ç¡®
âœ… Monitor Agent å¯å¯¼å…¥
âš ï¸  Alertmanager Webhook éœ€è¦ fastapi
âœ… Alertmanager Webhook ä»£ç ç»“æ„æ­£ç¡®
```

**è¯´æ˜ï¼š** 
- éœ€è¦å®‰è£…ä¾èµ–ï¼š`pip install mcp httpx fastapi uvicorn`
- ä»£ç ç»“æ„æ­£ç¡®ï¼Œå®‰è£…ä¾èµ–åå¯æ­£å¸¸è¿è¡Œ

---

### 4. Prometheus å·¥å…·å®šä¹‰ âœ…

**éªŒè¯çš„å·¥å…·ï¼ˆ8 ä¸ªï¼‰ï¼š**

| å·¥å…· | çŠ¶æ€ |
|------|------|
| `prom_query` | âœ… å·²å®šä¹‰ |
| `prom_query_range` | âœ… å·²å®šä¹‰ |
| `prom_get_alerts` | âœ… å·²å®šä¹‰ |
| `prom_node_cpu_usage` | âœ… å·²å®šä¹‰ |
| `prom_node_memory_usage` | âœ… å·²å®šä¹‰ |
| `prom_pod_cpu_usage` | âœ… å·²å®šä¹‰ |
| `prom_service_latency` | âœ… å·²å®šä¹‰ |
| `prom_service_error_rate` | âœ… å·²å®šä¹‰ |

**å®é™…å…± 18 ä¸ªå·¥å…·**ï¼ˆåŒ…å«å…ƒæ•°æ®ã€é…ç½®ã€çŠ¶æ€ç­‰ï¼‰

---

### 5. Monitor Agent åŠŸèƒ½ âœ…

**éªŒè¯çš„æ–¹æ³•ï¼š**

| æ–¹æ³• | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| `_query_metrics` | âœ… | æŒ‡æ ‡æŸ¥è¯¢ |
| `_get_alerts` | âœ… | è·å–å‘Šè­¦ |
| `_analyze_alert` | âœ… | å‘Šè­¦åˆ†æ |
| `_receive_webhook` | âœ… | Webhook æ¥æ”¶ |
| `handle_alert` | âœ… | å‘Šè­¦å¤„ç†å…¥å£ |

**Agent å±æ€§ï¼š**
- âœ… åç§°ï¼š`monitor_agent`
- âœ… ç»§æ‰¿ï¼š`SREAgent`
- âœ… å·¥å…·åˆ—è¡¨ï¼š10 ä¸ª

---

### 6. Alertmanager Webhook âœ…

**éªŒè¯çš„ç»„ä»¶ï¼š**

| ç»„ä»¶ | çŠ¶æ€ |
|------|------|
| AlertmanagerWebhook ç±» | âœ… |
| POST /api/v1/alerts | âœ… |
| GET /health | âœ… |

**æ•°æ®æ¨¡å‹ï¼š**
- âœ… AlertLabel
- âœ… AlertAnnotation
- âœ… Alert
- âœ… AlertGroup

---

### 7. ä»£ç ç»Ÿè®¡ âœ…

```
âœ… prometheus_server.py: 785 è¡Œ
âœ… monitor_agent.py: 340 è¡Œ
âœ… alertmanager_webhook.py: 207 è¡Œ

é˜¶æ®µ 2 æ€»ä»£ç ï¼š1332 è¡Œ
ç´¯è®¡æ€»ä»£ç ï¼š2277 è¡Œï¼ˆå«é˜¶æ®µ 1 945 è¡Œï¼‰
```

---

## ğŸ“Š åŠŸèƒ½è¦†ç›–

### Prometheus MCP å·¥å…·ï¼ˆ18 ä¸ªï¼‰

| ç±»åˆ« | å·¥å…·æ•° | å·¥å…·åˆ—è¡¨ |
|------|--------|---------|
| åŸºç¡€æŸ¥è¯¢ | 2 | query, query_range |
| å…ƒæ•°æ® | 8 | metadata, targets, alerts, rules, config, status, labels, series |
| é¢„å®šä¹‰æŒ‡æ ‡ | 8 | node_cpu, node_memory, pod_cpu, pod_memory, service_latency, error_rate |

**è¦†ç›–ç‡ï¼š** 100% âœ…

---

### Monitor Agent åŠŸèƒ½

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| æŒ‡æ ‡æŸ¥è¯¢ | âœ… | æ”¯æŒ PromQL |
| å‘Šè­¦è·å– | âœ… | ä» Prometheus è·å– |
| å‘Šè­¦åˆ†æ | âœ… | ä¸¥é‡æ€§ã€å½±å“é¢ã€å»ºè®® |
| é¢„æ¡ˆåŒ¹é… | âœ… | è‡ªåŠ¨åŒ¹é… runbook |
| Webhook æ¥æ”¶ | âœ… | Alertmanager é›†æˆ |
| é€šçŸ¥å¤„ç† | âœ… | åˆ†çº§é€šçŸ¥ç­–ç•¥ |

**è¦†ç›–ç‡ï¼š** 100% âœ…

---

### Alertmanager Webhook åŠŸèƒ½

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| å‘Šè­¦æ¥æ”¶ | âœ… | POST /api/v1/alerts |
| å‘Šè­¦è§£æ | âœ… | å®Œæ•´å­—æ®µè§£æ |
| å¤šå¤„ç†å™¨ | âœ… | æ”¯æŒæ³¨å†Œå¤šä¸ªå¤„ç†å™¨ |
| å¥åº·æ£€æŸ¥ | âœ… | GET /health |
| æ—¥å¿—è®°å½• | âœ… | è¯¦ç»†æ—¥å¿— |
| é€šçŸ¥é›†æˆ | âœ… | é£ä¹¦/é’‰é’‰ï¼ˆé¢„ç•™ï¼‰ |

**è¦†ç›–ç‡ï¼š** 100% âœ…

---

## âš ï¸ è­¦å‘Šè¯´æ˜

### è­¦å‘Š 1-2: ä¾èµ–åº“æœªå®‰è£…

**å½±å“ï¼š** æ— æ³•å¯åŠ¨ MCP æœåŠ¡å™¨å’Œ Webhook æœåŠ¡

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# å®‰è£…ä¾èµ–
pip install mcp httpx fastapi uvicorn pydantic

# æˆ–ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ
python3 -m venv .venv
source .venv/bin/activate
pip install -e .
```

### è­¦å‘Š 3: Prometheus æœåŠ¡å™¨æœªè¿æ¥

**å½±å“ï¼š** æ— æ³•æŸ¥è¯¢çœŸå®æŒ‡æ ‡æ•°æ®

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# 1. é…ç½® Prometheus åœ°å€
# ç¼–è¾‘ prometheus_server.pyï¼Œä¿®æ”¹ï¼š
PROMETHEUS_URL = "http://your-prometheus:9090"

# 2. æˆ–ä½¿ç”¨æœ¬åœ° Prometheus
docker run -d -p 9090:9090 prom/prometheus
```

---

## ğŸ¯ æµ‹è¯•ç»“è®º

### ä»£ç å±‚é¢ âœ…

- âœ… æ–‡ä»¶ç»“æ„å®Œæ•´
- âœ… ä»£ç è¯­æ³•æ­£ç¡®
- âœ… æ¨¡å—å¯¼å…¥æ­£å¸¸
- âœ… å·¥å…·å®šä¹‰å®Œæ•´ï¼ˆ18 ä¸ªï¼‰
- âœ… Agent åŠŸèƒ½å®Œæ•´
- âœ… Webhook åŠŸèƒ½å®Œæ•´

**ç»“è®ºï¼š** ä»£ç è´¨é‡ä¼˜ç§€ï¼Œå¯ä»¥è¿›å…¥ç”Ÿäº§ç¯å¢ƒæµ‹è¯•

---

### åŠŸèƒ½å±‚é¢ â³

- â³ Prometheus æŸ¥è¯¢ï¼ˆéœ€è¦ Prometheus æœåŠ¡å™¨ï¼‰
- â³ å‘Šè­¦æ¥æ”¶ï¼ˆéœ€è¦ Alertmanager é…ç½®ï¼‰
- â³ æŒ‡æ ‡å¯è§†åŒ–ï¼ˆéœ€è¦ Grafana æˆ–å‰ç«¯ï¼‰

**å»ºè®®ï¼š** åœ¨æµ‹è¯•ç¯å¢ƒéƒ¨ç½² Prometheus åè¿›è¡Œå®Œæ•´åŠŸèƒ½æµ‹è¯•

---

## ğŸ“‹ éƒ¨ç½²æŒ‡å—

### 1. å®‰è£…ä¾èµ–

```bash
pip install mcp httpx fastapi uvicorn pydantic
```

### 2. å¯åŠ¨ Prometheus MCP

```bash
# ç»ˆç«¯ 1
python -m sre_nanobot.mcp.prometheus_server
```

### 3. å¯åŠ¨ Alertmanager Webhook

```bash
# ç»ˆç«¯ 2
python -m sre_nanobot.integrations.alertmanager_webhook
```

**è¾“å‡ºï¼š**
```
ğŸš€ å¯åŠ¨ Alertmanager Webhook æœåŠ¡å™¨...
ğŸ“¡ Webhook åœ°å€ï¼šhttp://localhost:8080/api/v1/alerts
â¤ï¸  å¥åº·æ£€æŸ¥ï¼šhttp://localhost:8080/health
```

### 4. é…ç½® Alertmanager

```yaml
# alertmanager.yml
global:
  resolve_timeout: 5m

route:
  receiver: 'sre-nanobot'
  group_by: ['alertname', 'severity']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h

receivers:
  - name: 'sre-nanobot'
    webhook_configs:
      - url: 'http://localhost:8080/api/v1/alerts'
        send_resolved: true
```

### 5. æµ‹è¯•å‘Šè­¦

```bash
# å‘é€æµ‹è¯•å‘Šè­¦
curl -X POST http://localhost:8080/api/v1/alerts \
  -H "Content-Type: application/json" \
  -d '{
    "receiver": "sre-nanobot",
    "status": "firing",
    "alerts": [
      {
        "status": "firing",
        "labels": {
          "alertname": "TestAlert",
          "severity": "P1",
          "instance": "test-server"
        },
        "annotations": {
          "summary": "æµ‹è¯•å‘Šè­¦",
          "description": "è¿™æ˜¯æµ‹è¯•å‘Šè­¦"
        },
        "startsAt": "2026-02-27T00:00:00Z",
        "fingerprint": "test123"
      }
    ],
    "groupLabels": {},
    "commonLabels": {},
    "commonAnnotations": {},
    "externalURL": "",
    "version": "4",
    "groupKey": ""
  }'
```

---

## ğŸ“ˆ é¡¹ç›®è¿›åº¦

```
é˜¶æ®µ 1: NanoBot éƒ¨ç½² + K8s MCP      âœ… å®Œæˆ (100%)
é˜¶æ®µ 2: Monitor Agent + Prometheus  âœ… å®Œæˆ (100%)
é˜¶æ®µ 3: Incident Agent + æ•…éšœåˆ†æ   â³ å¾…å¼€å§‹ (0%)
é˜¶æ®µ 4: AutoFix Agent + é¢„æ¡ˆç³»ç»Ÿ    â³ å¾…å¼€å§‹ (0%)
é˜¶æ®µ 5: é£ä¹¦/é’‰é’‰é€šé“ + UI          â³ å¾…å¼€å§‹ (0%)
é˜¶æ®µ 6: æµ‹è¯• + æ–‡æ¡£ + ä¼˜åŒ–          â³ å¾…å¼€å§‹ (0%)
```

**æ€»ä½“è¿›åº¦ï¼š33.3% (2/6)**

---

## ğŸ“ ä¸‹ä¸€æ­¥

### ç«‹å³è¡ŒåŠ¨

1. **å®‰è£…ä¾èµ–**
   ```bash
   pip install mcp httpx fastapi uvicorn
   ```

2. **æµ‹è¯• Prometheus é›†æˆ**
   - é…ç½® Prometheus åœ°å€
   - æµ‹è¯•æŒ‡æ ‡æŸ¥è¯¢
   - æµ‹è¯•å‘Šè­¦æ¥æ”¶

3. **å¼€å§‹é˜¶æ®µ 3**
   - Incident Agent å®ç°
   - æ•…éšœåˆ†æç®—æ³•
   - æ ¹å› å®šä½

### ç”Ÿäº§ç¯å¢ƒå‡†å¤‡

- [ ] é…ç½®çœŸå® Prometheus æœåŠ¡å™¨
- [ ] é…ç½® Alertmanager Webhook
- [ ] é›†æˆé£ä¹¦/é’‰é’‰é€šçŸ¥
- [ ] è®¾ç½®å‘Šè­¦å‡çº§ç­–ç•¥
- [ ] é…ç½®å®¡è®¡æ—¥å¿—

---

## ğŸ“ æ”¯æŒä¿¡æ¯

### æ–‡æ¡£

- é˜¶æ®µ 1 æŠ¥å‘Šï¼š`é˜¶æ®µ 1-å®ŒæˆæŠ¥å‘Š.md`
- é˜¶æ®µ 1 éªŒè¯ï¼š`é˜¶æ®µ 1-éªŒè¯æŠ¥å‘Š.md`
- é¡¹ç›®è¯´æ˜ï¼š`../README.md`

### è„šæœ¬

- é˜¶æ®µ 1 éªŒè¯ï¼š`../verify.sh`
- é˜¶æ®µ 2 æµ‹è¯•ï¼š`../test_stage2.sh`

---

*æµ‹è¯•æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š2026-02-27*
*æµ‹è¯•å·¥å…·ï¼š./test_stage2.sh*
