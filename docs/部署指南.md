# éƒ¨ç½²æŒ‡å—

> ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæ•´æŒ‡å—

---

## ğŸ“‹ éƒ¨ç½²æ–¹å¼

| æ–¹å¼ | é€‚åˆåœºæ™¯ | éš¾åº¦ | æ—¶é—´ |
|------|---------|------|------|
| Docker | å¿«é€Ÿéƒ¨ç½² | â­â­ | 10 åˆ†é’Ÿ |
| Kubernetes | ç”Ÿäº§ç¯å¢ƒ | â­â­â­ | 30 åˆ†é’Ÿ |
| æºç éƒ¨ç½² | å¼€å‘æµ‹è¯• | â­â­â­â­ | 1 å°æ—¶ |

---

## ğŸ³ Docker éƒ¨ç½²ï¼ˆæ¨èï¼‰

### å‰ç½®è¦æ±‚

- Docker 20.10+
- Docker Compose 2.0+

### 1. å‡†å¤‡é…ç½®æ–‡ä»¶

```bash
# åˆ›å»ºé…ç½®ç›®å½•
mkdir -p /opt/sre-nanobot/config

# å¤åˆ¶é…ç½®æ–‡ä»¶
cp config.example.json /opt/sre-nanobot/config/config.json

# ç¼–è¾‘é…ç½®
vim /opt/sre-nanobot/config/config.json
```

### 2. åˆ›å»º Docker Compose æ–‡ä»¶

```yaml
# docker-compose.yml
version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    image: sre-nanobot-backend:latest
    container_name: sre-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./config/config.json:/app/config.json
      - ./logs:/app/logs
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=INFO
    networks:
      - sre-network

  frontend:
    build:
      context: ./webui/frontend
      dockerfile: Dockerfile
    image: sre-nanobot-frontend:latest
    container_name: sre-frontend
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      - backend
    networks:
      - sre-network

networks:
  sre-network:
    driver: bridge
```

### 3. åˆ›å»º Dockerfile

**åç«¯ Dockerfileï¼š**
```dockerfile
# Dockerfile.backend
FROM python:3.10-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£… kubectlï¼ˆå¯é€‰ï¼‰
RUN curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" \
    && chmod +x kubectl \
    && mv kubectl /usr/local/bin/

# å¤åˆ¶ä»£ç 
COPY . .

# å®‰è£… Python ä¾èµ–
RUN pip install --no-cache-dir -e .

# åˆ›å»ºæ—¥å¿—ç›®å½•
RUN mkdir -p /app/logs

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "webui.backend.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**å‰ç«¯ Dockerfileï¼š**
```dockerfile
# webui/frontend/Dockerfile
FROM node:18-alpine as builder

WORKDIR /app

# å¤åˆ¶ package.json
COPY package*.json ./

# å®‰è£…ä¾èµ–
RUN npm ci

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
RUN npm run build

# ç”Ÿäº§é•œåƒ
FROM nginx:alpine

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/dist /usr/share/nginx/html

# å¤åˆ¶ nginx é…ç½®
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

### 4. å¯åŠ¨æœåŠ¡

```bash
# æ„å»ºé•œåƒ
docker-compose build

# å¯åŠ¨æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# åœæ­¢æœåŠ¡
docker-compose down
```

### 5. éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose ps

# æµ‹è¯•åç«¯
curl http://localhost:8000/api/health

# è®¿é—®å‰ç«¯
æ‰“å¼€ http://localhost:3000
```

---

## â˜¸ï¸ Kubernetes éƒ¨ç½²

### å‰ç½®è¦æ±‚

- Kubernetes 1.20+
- Helm 3.0+ï¼ˆå¯é€‰ï¼‰
- kubectl é…ç½®å®Œæˆ

### æ–¹å¼ 1ï¼šä½¿ç”¨ YAML æ–‡ä»¶

#### 1. åˆ›å»ºå‘½åç©ºé—´

```yaml
# namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: sre-nanobot
```

#### 2. åˆ›å»º ConfigMap

```yaml
# configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: sre-config
  namespace: sre-nanobot
data:
  config.json: |
    {
      "providers": {
        "dashscope": {
          "apiKey": "your-api-key"
        }
      }
    }
```

#### 3. åˆ›å»º Deployment

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sre-backend
  namespace: sre-nanobot
spec:
  replicas: 2
  selector:
    matchLabels:
      app: sre-backend
  template:
    metadata:
      labels:
        app: sre-backend
    spec:
      containers:
      - name: backend
        image: sre-nanobot-backend:latest
        ports:
        - containerPort: 8000
        volumeMounts:
        - name: config
          mountPath: /app/config.json
          subPath: config.json
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /api/health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
      volumes:
      - name: config
        configMap:
          name: sre-config
```

#### 4. åˆ›å»º Service

```yaml
# service.yaml
apiVersion: v1
kind: Service
metadata:
  name: sre-backend
  namespace: sre-nanobot
spec:
  selector:
    app: sre-backend
  ports:
  - port: 8000
    targetPort: 8000
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: sre-frontend
  namespace: sre-nanobot
spec:
  selector:
    app: sre-frontend
  ports:
  - port: 80
    targetPort: 80
  type: LoadBalancer
```

#### 5. éƒ¨ç½²

```bash
# åº”ç”¨é…ç½®
kubectl apply -f namespace.yaml
kubectl apply -f configmap.yaml
kubectl apply -f deployment.yaml
kubectl apply -f service.yaml

# æŸ¥çœ‹çŠ¶æ€
kubectl get pods -n sre-nanobot
kubectl get svc -n sre-nanobot

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -f deployment/sre-backend -n sre-nanobot
```

### æ–¹å¼ 2ï¼šä½¿ç”¨ Helm Chart

```bash
# æ·»åŠ  Helm Chartï¼ˆå¾…æä¾›ï¼‰
helm repo add sre-nanobot https://your-repo.com/charts
helm install sre-nanobot sre-nanobot/sre-nanobot \
  --namespace sre-nanobot \
  --create-namespace \
  -f values.yaml
```

---

## ğŸ’» æºç éƒ¨ç½²

### 1. å®‰è£…ç³»ç»Ÿä¾èµ–

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y python3 python3-pip nodejs npm git curl

# å®‰è£… kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
chmod +x kubectl
sudo mv kubectl /usr/local/bin/
```

### 2. å…‹éš†é¡¹ç›®

```bash
git clone https://github.com/bugtest/sre-nanobot.git
cd sre-nanobot
```

### 3. å®‰è£… Python ä¾èµ–

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install -e .
```

### 4. å®‰è£…å‰ç«¯ä¾èµ–

```bash
cd webui/frontend
npm install
npm run build
cd ../..
```

### 5. é…ç½®

```bash
cp config.example.json ~/.nanobot/config.json
vim ~/.nanobot/config.json
```

### 6. å¯åŠ¨æœåŠ¡

**æ–¹å¼ 1ï¼šä½¿ç”¨ systemdï¼ˆæ¨èï¼‰**

```bash
# åˆ›å»º systemd æœåŠ¡æ–‡ä»¶
sudo tee /etc/systemd/system/sre-backend.service > /dev/null <<EOF
[Unit]
Description=SRE-NanoBot Backend
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/opt/sre-nanobot
Environment="PATH=/opt/sre-nanobot/venv/bin"
ExecStart=/opt/sre-nanobot/venv/bin/uvicorn webui.backend.main:app --host 0.0.0.0 --port 8000
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# å¯ç”¨æœåŠ¡
sudo systemctl daemon-reload
sudo systemctl enable sre-backend
sudo systemctl start sre-backend

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status sre-backend
```

**æ–¹å¼ 2ï¼šä½¿ç”¨ supervisor**

```bash
# å®‰è£… supervisor
sudo apt install supervisor

# åˆ›å»ºé…ç½®æ–‡ä»¶
sudo tee /etc/supervisor/conf.d/sre-backend.conf > /dev/null <<EOF
[program:sre-backend]
command=/opt/sre-nanobot/venv/bin/uvicorn webui.backend.main:app --host 0.0.0.0 --port 8000
directory=/opt/sre-nanobot
user=ubuntu
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/sre-backend.log
EOF

# å¯åŠ¨æœåŠ¡
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start sre-backend
```

**æ–¹å¼ 3ï¼šåå°è¿è¡Œ**

```bash
# ä½¿ç”¨ nohup
nohup uvicorn webui.backend.main:app --host 0.0.0.0 --port 8000 > backend.log 2>&1 &

# ä½¿ç”¨ screen
screen -S sre-backend
uvicorn webui.backend.main:app --host 0.0.0.0 --port 8000
# Ctrl+A, D é€€å‡º screen
```

### 7. é…ç½® Nginx åå‘ä»£ç†

```nginx
# /etc/nginx/sites-available/sre-nanobot
server {
    listen 80;
    server_name sre.example.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/ {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /ws/ {
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

# å¯ç”¨é…ç½®
sudo ln -s /etc/nginx/sites-available/sre-nanobot /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

---

## ğŸ” å®‰å…¨é…ç½®

### 1. é…ç½® HTTPS

```bash
# ä½¿ç”¨ Let's Encrypt
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d sre.example.com
```

### 2. é…ç½®é˜²ç«å¢™

```bash
# Ubuntu
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# CentOS
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 3. é…ç½®è®¿é—®æ§åˆ¶

```nginx
# Nginx è®¿é—®æ§åˆ¶
location / {
    allow 192.168.1.0/24;  # å†…ç½‘ IP
    deny all;
    proxy_pass http://localhost:3000;
}
```

### 4. é…ç½®æ—¥å¿—è½®è½¬

```bash
# /etc/logrotate.d/sre-nanobot
/var/log/sre-backend.log {
    daily
    rotate 7
    compress
    delaycompress
    notifempty
    create 0640 ubuntu ubuntu
    postrotate
        systemctl reload sre-backend
    endscript
}
```

---

## ğŸ“Š ç›‘æ§å’Œå‘Šè­¦

### 1. é…ç½® Prometheus ç›‘æ§

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'sre-nanobot'
    static_configs:
      - targets: ['sre-backend:8000']
```

### 2. é…ç½®å¥åº·æ£€æŸ¥

```yaml
# Kubernetes liveness probe
livenessProbe:
  httpGet:
    path: /api/health
    port: 8000
  initialDelaySeconds: 30
  periodSeconds: 10
```

### 3. é…ç½®æ—¥å¿—æ”¶é›†

```yaml
# Fluentd é…ç½®
<match sre-nanobot.**>
  @type elasticsearch
  host elasticsearch
  port 9200
  logstash_format true
  logstash_prefix sre-nanobot
</match>
```

---

## ğŸ§ª éªŒè¯éƒ¨ç½²

### æ£€æŸ¥æ¸…å•

- [ ] åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ
- [ ] å‰ç«¯é¡µé¢å¯è®¿é—®
- [ ] API æ–‡æ¡£å¯è®¿é—®
- [ ] WebSocket è¿æ¥æ­£å¸¸
- [ ] æ—¥å¿—æ­£å¸¸è¾“å‡º
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] ç›‘æ§æ•°æ®æ­£å¸¸

### æµ‹è¯•å‘½ä»¤

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8000/api/health

# API æµ‹è¯•
curl http://localhost:8000/api/alerts
curl http://localhost:8000/api/incidents
curl http://localhost:8000/api/runbooks

# è®¿é—®å‰ç«¯
æ‰“å¼€ http://localhost:3000

# è®¿é—® API æ–‡æ¡£
æ‰“å¼€ http://localhost:8000/docs
```

---

## ğŸ†˜ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**Q: æœåŠ¡å¯åŠ¨å¤±è´¥**

A: æ£€æŸ¥æ—¥å¿—ï¼š
```bash
docker-compose logs
# æˆ–
sudo journalctl -u sre-backend -f
```

**Q: å‰ç«¯æ— æ³•è®¿é—®åç«¯**

A: æ£€æŸ¥ CORS é…ç½®å’Œç½‘ç»œè¿æ¥

**Q: WebSocket è¿æ¥å¤±è´¥**

A: æ£€æŸ¥ Nginx WebSocket é…ç½®

**Q: å†…å­˜ä¸è¶³**

A: è°ƒæ•´å®¹å™¨/Pod èµ„æºé™åˆ¶

---

## ğŸ“ æ”¯æŒ

- **æ–‡æ¡£:** æŸ¥çœ‹ [docs/](./) ç›®å½•
- **Issues:** https://github.com/bugtest/sre-nanobot/issues
- **API æ–‡æ¡£:** http://localhost:8000/docs

---

*æœ€åæ›´æ–°ï¼š2026-02-27*
