# é˜¶æ®µ 2 å®ŒæˆæŠ¥å‘Š

> Monitor Agent + Prometheus é›†æˆ

---

## âœ… å®Œæˆå†…å®¹

### 1. Prometheus MCP æœåŠ¡å™¨

**æ–‡ä»¶ï¼š** `sre_nanobot/mcp/prometheus_server.py` (700+ è¡Œ)

**16 ä¸ªå·¥å…·å…¨éƒ¨å®ç°ï¼š**

#### åŸºç¡€æŸ¥è¯¢å·¥å…·
| å·¥å…· | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|
| `prom_query` | å³æ—¶æŸ¥è¯¢ | âœ… |
| `prom_query_range` | èŒƒå›´æŸ¥è¯¢ | âœ… |
| `prom_get_metric_metadata` | æŒ‡æ ‡å…ƒæ•°æ® | âœ… |
| `prom_get_series` | æ—¶é—´åºåˆ— | âœ… |

#### ç›‘æ§å·¥å…·
| å·¥å…· | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|
| `prom_get_targets` | æŠ“å–ç›®æ ‡ | âœ… |
| `prom_get_label_values` | æ ‡ç­¾å€¼ | âœ… |
| `prom_node_cpu_usage` | èŠ‚ç‚¹ CPU | âœ… |
| `prom_node_memory_usage` | èŠ‚ç‚¹å†…å­˜ | âœ… |
| `prom_pod_cpu_usage` | Pod CPU | âœ… |
| `prom_pod_memory_usage` | Pod å†…å­˜ | âœ… |

#### å‘Šè­¦å·¥å…·
| å·¥å…· | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|
| `prom_get_alerts` | å‘Šè­¦åˆ—è¡¨ | âœ… |
| `prom_get_rules` | è§„åˆ™åˆ—è¡¨ | âœ… |
| `prom_get_config` | é…ç½® | âœ… |
| `prom_get_status` | çŠ¶æ€ | âœ… |

#### æœåŠ¡ç›‘æ§å·¥å…·
| å·¥å…· | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|
| `prom_service_latency` | æœåŠ¡å»¶è¿Ÿ | âœ… |
| `prom_service_error_rate` | é”™è¯¯ç‡ | âœ… |

---

### 2. Monitor Agent

**æ–‡ä»¶ï¼š** `sre_nanobot/agents/monitor_agent.py` (300+ è¡Œ)

**åŠŸèƒ½å®ç°ï¼š**
- âœ… ç›‘æ§æŒ‡æ ‡æŸ¥è¯¢
- âœ… å‘Šè­¦æ¥æ”¶å’Œåˆ†æ
- âœ… å‘Šè­¦çº§åˆ«è¯†åˆ«ï¼ˆP0-P3ï¼‰
- âœ… å—å½±å“æœåŠ¡æå–
- âœ… ç›¸å…³æŒ‡æ ‡å…³è”
- âœ… å»ºè®®æ“ä½œç”Ÿæˆ
- âœ… é¢„æ¡ˆåŒ¹é…
- âœ… Webhook æ¥æ”¶

**æ ¸å¿ƒæ–¹æ³•ï¼š**
```python
execute()           # æ‰§è¡Œç›‘æ§ä»»åŠ¡
query_metrics()     # æŸ¥è¯¢æŒ‡æ ‡
get_alerts()        # è·å–å‘Šè­¦
analyze_alert()     # åˆ†æå‘Šè­¦
receive_webhook()   # æ¥æ”¶ Webhook
handle_alert()      # å¤„ç†å‘Šè­¦
```

---

### 3. Alertmanager Webhook

**æ–‡ä»¶ï¼š** `sre_nanobot/integrations/alertmanager_webhook.py` (200+ è¡Œ)

**åŠŸèƒ½ï¼š**
- âœ… FastAPI Webhook æœåŠ¡å™¨
- âœ… å‘Šè­¦æ•°æ®æ¨¡å‹ï¼ˆPydanticï¼‰
- âœ… å‘Šè­¦ç»„å¤„ç†
- âœ… å¤„ç†å™¨æ³¨å†Œæœºåˆ¶
- âœ… æ—¥å¿—è®°å½•å¤„ç†å™¨
- âœ… é€šçŸ¥å¤„ç†å™¨ï¼ˆé¢„ç•™ï¼‰
- âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹

**API ç«¯ç‚¹ï¼š**
```
POST /api/v1/alerts    # æ¥æ”¶å‘Šè­¦
GET  /health          # å¥åº·æ£€æŸ¥
GET  /metrics         # ç»Ÿè®¡ä¿¡æ¯
```

---

### 4. é…ç½®æ›´æ–°

**æ–‡ä»¶ï¼š** `config.example.json`

**æ–°å¢é…ç½®ï¼š**
```json
{
  "tools": {
    "mcpServers": {
      "prometheus": {
        "url": "https://prometheus.example.com/sse",
        "headers": {
          "Authorization": "Bearer xxx"
        },
        "toolTimeout": 60
      }
    }
  },
  "sre": {
    "alerting": {
      "enabled": true,
      "channels": ["feishu", "dingtalk"],
      "severity_levels": {
        "P0": ["phone", "feishu", "dingtalk"],
        "P1": ["feishu", "dingtalk"],
        "P2": ["feishu"],
        "P3": ["feishu"]
      }
    }
  }
}
```

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

| æ–‡ä»¶ | è¡Œæ•° | è¯´æ˜ |
|------|------|------|
| `mcp/prometheus_server.py` | 700+ | Prometheus MCP |
| `agents/monitor_agent.py` | 300+ | Monitor Agent |
| `integrations/alertmanager_webhook.py` | 200+ | Webhook æ¥æ”¶å™¨ |
| **é˜¶æ®µ 2 æ–°å¢** | **1200+** | |
| **ç´¯è®¡** | **2145+** | é˜¶æ®µ 1 + é˜¶æ®µ 2 |

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### 1. æŸ¥è¯¢æŒ‡æ ‡

```bash
# æŸ¥è¯¢ Pod CPU ä½¿ç”¨ç‡
nanobot agent -m "æŸ¥çœ‹ production å‘½åç©ºé—´çš„ Pod CPU ä½¿ç”¨ç‡"

# æŸ¥è¯¢èŠ‚ç‚¹å†…å­˜
nanobot agent -m "æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹çš„å†…å­˜ä½¿ç”¨ç‡"

# æŸ¥è¯¢æœåŠ¡å»¶è¿Ÿ
nanobot agent -m "æŸ¥è¯¢ api-service çš„ P99 å»¶è¿Ÿ"
```

### 2. æŸ¥çœ‹å‘Šè­¦

```bash
# æŸ¥çœ‹å½“å‰å‘Šè­¦
nanobot agent -m "æŸ¥çœ‹å½“å‰æ­£åœ¨è§¦å‘çš„å‘Šè­¦"

# æŸ¥çœ‹å‘Šè­¦è§„åˆ™
nanobot agent -m "æŸ¥çœ‹å‘Šè­¦è§„åˆ™åˆ—è¡¨"
```

### 3. å‘Šè­¦åˆ†æ

```bash
# åˆ†æç‰¹å®šå‘Šè­¦
nanobot agent -m "åˆ†æ PodCrashLooping å‘Šè­¦ï¼Œnamespace=production"

# è·å–å»ºè®®æ“ä½œ
nanobot agent -m "HighCPUUsage å‘Šè­¦åº”è¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ"
```

### 4. æ¥æ”¶ Webhook å‘Šè­¦

```bash
# å¯åŠ¨ Webhook æœåŠ¡å™¨
python -m sre_nanobot.integrations.alertmanager_webhook

# Alertmanager é…ç½®
receivers:
  - name: 'sre-nanobot'
    webhook_configs:
      - url: 'http://sre-nanobot:8080/api/v1/alerts'
        send_resolved: true
```

---

## ğŸ”§ é…ç½® Prometheus

### 1. æœ¬åœ° Prometheus

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod
  - job_name: 'kubernetes-nodes'
    kubernetes_sd_configs:
      - role: node
```

### 2. é…ç½® Alertmanager

```yaml
# alertmanager.yml
route:
  group_by: ['alertname', 'severity']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: 'sre-nanobot'

receivers:
  - name: 'sre-nanobot'
    webhook_configs:
      - url: 'http://sre-nanobot:8080/api/v1/alerts'
        send_resolved: true
```

---

## ğŸ“‹ éªŒè¯æ­¥éª¤

### 1. æµ‹è¯• Prometheus è¿æ¥

```bash
# æ£€æŸ¥ Prometheus å¯è®¿é—®æ€§
curl http://prometheus:9090/api/v1/status/config

# æµ‹è¯•æŸ¥è¯¢
curl 'http://prometheus:9090/api/v1/query?query=up'
```

### 2. æµ‹è¯• MCP æœåŠ¡å™¨

```bash
# å¯åŠ¨ Prometheus MCP æœåŠ¡å™¨
python -m sre_nanobot.mcp.prometheus_server

# æµ‹è¯•å·¥å…·åˆ—è¡¨
mcp-cli list-tools --server sre_nanobot.mcp.prometheus_server
```

### 3. æµ‹è¯• Webhook

```bash
# å¯åŠ¨ Webhook æœåŠ¡å™¨
python -m sre_nanobot.integrations.alertmanager_webhook

# å‘é€æµ‹è¯•å‘Šè­¦
curl -X POST http://localhost:8080/api/v1/alerts \
  -H "Content-Type: application/json" \
  -d '{
    "status": "firing",
    "alerts": [
      {
        "status": "firing",
        "labels": {
          "alertname": "TestAlert",
          "severity": "P2",
          "instance": "test:8080"
        },
        "annotations": {
          "summary": "æµ‹è¯•å‘Šè­¦",
          "description": "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å‘Šè­¦"
        },
        "startsAt": "2026-02-27T00:00:00Z",
        "fingerprint": "test123"
      }
    ],
    "groupKey": "test",
    "receiver": "sre-nanobot",
    "externalURL": "http://alertmanager:9093"
  }'
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Prometheus è¿æ¥

- ç¡®ä¿ Prometheus æœåŠ¡å™¨å¯è®¿é—®
- é…ç½®æ­£ç¡®çš„è®¤è¯ä¿¡æ¯ï¼ˆå¦‚éœ€è¦ï¼‰
- è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´

### 2. å‘Šè­¦å¤„ç†

- å½“å‰é€šçŸ¥å¤„ç†å™¨æ˜¯ç¤ºä¾‹ï¼Œéœ€è¦é›†æˆå®é™…é€šçŸ¥æ¸ é“
- å‘Šè­¦çº§åˆ«æ˜ å°„éœ€è¦æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
- å»ºè®®æ“ä½œå’Œé¢„æ¡ˆåŒ¹é…å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–

### 3. æ€§èƒ½è€ƒè™‘

- å¤§é‡æ—¶é—´åºåˆ—æŸ¥è¯¢å¯èƒ½å½±å“ Prometheus æ€§èƒ½
- å»ºè®®è®¾ç½®æŸ¥è¯¢è¶…æ—¶å’Œé™åˆ¶
- è€ƒè™‘æ·»åŠ æŸ¥è¯¢ç¼“å­˜

---

## ğŸš€ ä¸‹ä¸€æ­¥ï¼ˆé˜¶æ®µ 3ï¼‰

### Incident Agent + æ•…éšœåˆ†æ

- [ ] Incident Agent å®ç°
- [ ] æ ¹å› åˆ†æç®—æ³•
- [ ] æ—¥å¿—å…³è”åˆ†æï¼ˆLoki é›†æˆï¼‰
- [ ] æ‹“æ‰‘åˆ†æ
- [ ] æ•…éšœæŠ¥å‘Šç”Ÿæˆ

### é¢„è®¡æ—¶é—´ï¼š1 å‘¨

---

## ğŸ“ æ”¯æŒ

- æ–‡æ¡£ï¼š./docs/
- é…ç½®ç¤ºä¾‹ï¼š../config.example.json
- éªŒè¯è„šæœ¬ï¼š../verify.sh

---

*é˜¶æ®µ 2 å®Œæˆï¼2026-02-27*
