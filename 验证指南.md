# é˜¶æ®µ 1 éªŒè¯æŒ‡å—

> éªŒè¯ K8s MCP æœåŠ¡å™¨å’Œ Agent åŠŸèƒ½

---

## ğŸ“‹ éªŒè¯æ¸…å•

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| é¡¹ç›®ç»“æ„ | â³ | æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§ |
| Python ä¾èµ– | â³ | å®‰è£…å¿…è¦ä¾èµ– |
| K8s ç¯å¢ƒ | â³ | kubectl å’Œé›†ç¾¤è¿æ¥ |
| MCP æœåŠ¡å™¨ | â³ | å¯åŠ¨å’Œå·¥å…·æµ‹è¯• |
| NanoBot é›†æˆ | â³ | é…ç½®å’Œå¯¹è¯æµ‹è¯• |

---

## æ­¥éª¤ 1: æ£€æŸ¥é¡¹ç›®ç»“æ„

```bash
cd /home/ubuntu/.openclaw/workspace/sre-nanobot

# æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§
ls -la
ls -la sre_nanobot/
ls -la sre_nanobot/mcp/
ls -la sre_nanobot/agents/
```

**é¢„æœŸè¾“å‡ºï¼š**
```
âœ… README.md
âœ… pyproject.toml
âœ… config.example.json
âœ… sre_nanobot/mcp/k8s_server.py
âœ… sre_nanobot/agents/k8s_agent.py
âœ… scripts/test_k8s_mcp.sh
```

---

## æ­¥éª¤ 2: å®‰è£… Python ä¾èµ–

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆæ¨èï¼‰
python3 -m venv .venv
source .venv/bin/activate

# å®‰è£… MCP åº“
pip install mcp

# æˆ–å®‰è£…å®Œæ•´ä¾èµ–
pip install -e .
```

**éªŒè¯å®‰è£…ï¼š**
```bash
python -c "import mcp; print('âœ… MCP åº“å®‰è£…æˆåŠŸ')"
```

---

## æ­¥éª¤ 3: æ£€æŸ¥ K8s ç¯å¢ƒ

### 3.1 æ£€æŸ¥ kubectl

```bash
which kubectl
kubectl version --client
```

**å¦‚æœæœªå®‰è£… kubectlï¼š**

```bash
# Linux å®‰è£…
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
chmod +x kubectl
sudo mv kubectl /usr/local/bin/

# macOS å®‰è£…
brew install kubectl
```

### 3.2 æ£€æŸ¥é›†ç¾¤è¿æ¥

```bash
# æµ‹è¯•é›†ç¾¤è¿æ¥
kubectl cluster-info

# æŸ¥çœ‹èŠ‚ç‚¹
kubectl get nodes

# æŸ¥çœ‹å‘½åç©ºé—´
kubectl get namespaces
```

**å¦‚æœæ²¡æœ‰ K8s é›†ç¾¤ï¼š**

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ›¿ä»£æ–¹æ¡ˆéªŒè¯ï¼š

1. **æœ¬åœ°æµ‹è¯•æ¨¡å¼**ï¼ˆä¸éœ€è¦çœŸå®é›†ç¾¤ï¼‰
   ```bash
   # ä½¿ç”¨ mock æ¨¡å¼æµ‹è¯• MCP æœåŠ¡å™¨
   python -m sre_nanobot.mcp.k8s_server --mock
   ```

2. **ä½¿ç”¨ Kind åˆ›å»ºæœ¬åœ°é›†ç¾¤**
   ```bash
   # å®‰è£… kind
   curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
   chmod +x ./kind
   sudo mv ./kind /usr/local/bin/kind
   
   # åˆ›å»ºé›†ç¾¤
   kind create cluster --name sre-test
   
   # éªŒè¯
   kubectl cluster-info
   ```

3. **ä½¿ç”¨ Minikube**
   ```bash
   # å®‰è£… minikube
   curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
   sudo install minikube-linux-amd64 /usr/local/bin/minikube
   
   # å¯åŠ¨é›†ç¾¤
   minikube start
   ```

---

## æ­¥éª¤ 4: æµ‹è¯• MCP æœåŠ¡å™¨

### 4.1 å¯åŠ¨æµ‹è¯•

```bash
cd /home/ubuntu/.openclaw/workspace/sre-nanobot

# å¯åŠ¨ MCP æœåŠ¡å™¨ï¼ˆå‰å°ï¼‰
python -m sre_nanobot.mcp.k8s_server
```

**é¢„æœŸè¾“å‡ºï¼š**
```
INFO: Starting MCP server 'sre-k8s-mcp'
INFO: Server started successfully
```

### 4.2 æµ‹è¯•å·¥å…·åˆ—è¡¨

ä½¿ç”¨ MCP æµ‹è¯•å·¥å…·ï¼š

```bash
# å®‰è£… mcp-cliï¼ˆå¯é€‰ï¼‰
pip install mcp-cli

# åˆ—å‡ºå·¥å…·
mcp-cli list-tools --server sre_nanobot.mcp.k8s_server
```

**é¢„æœŸè¾“å‡ºï¼š**
```
âœ… kubectl_get_pods
âœ… kubectl_get_deployments
âœ… kubectl_get_services
âœ… kubectl_get_events
âœ… kubectl_get_nodes
âœ… kubectl_get_logs
âœ… kubectl_describe_pod
âœ… kubectl_describe_node
âœ… kubectl_restart_deployment
âœ… kubectl_scale_deployment
âœ… kubectl_get_resource_usage
```

### 4.3 æµ‹è¯•å•ä¸ªå·¥å…·

```bash
# æµ‹è¯• get_nodesï¼ˆä¸éœ€è¦ namespaceï¼‰
python -c "
import asyncio
from sre_nanobot.mcp.k8s_server import get_nodes

async def test():
    result = await get_nodes({})
    print(result[0].text)

asyncio.run(test())
"
```

---

## æ­¥éª¤ 5: æµ‹è¯• K8s Agent

### 5.1 å•å…ƒæµ‹è¯•

```bash
cd /home/ubuntu/.openclaw/workspace/sre-nanobot

# åˆ›å»ºæµ‹è¯•æ–‡ä»¶
cat > tests/test_k8s_agent.py << 'EOF'
import pytest
import asyncio
from sre_nanobot.agents.k8s_agent import K8sAgent, TaskResult

@pytest.fixture
def k8s_agent():
    return K8sAgent()

@pytest.mark.asyncio
async def test_agent_initialization(k8s_agent):
    """æµ‹è¯• Agent åˆå§‹åŒ–"""
    await k8s_agent.initialize()
    assert k8s_agent.initialized == True
    assert k8s_agent.name == "k8s_agent"

@pytest.mark.asyncio
async def test_validate_get_pods(k8s_agent):
    """æµ‹è¯•å‚æ•°éªŒè¯ - get_pods"""
    task = {
        "action": "get_pods",
        "params": {"namespace": "default"}
    }
    is_valid, error = await k8s_agent.validate(task)
    assert is_valid == True
    assert error is None

@pytest.mark.asyncio
async def test_validate_missing_namespace(k8s_agent):
    """æµ‹è¯•å‚æ•°éªŒè¯ - ç¼ºå°‘ namespace"""
    task = {
        "action": "get_pods",
        "params": {}
    }
    is_valid, error = await k8s_agent.validate(task)
    assert is_valid == False
    assert "namespace" in error

@pytest.mark.asyncio
async def test_validate_scale_deployment(k8s_agent):
    """æµ‹è¯•å‚æ•°éªŒè¯ - scale_deployment"""
    task = {
        "action": "scale_deployment",
        "params": {
            "namespace": "default",
            "deployment": "test",
            "replicas": 5
        }
    }
    is_valid, error = await k8s_agent.validate(task)
    assert is_valid == True

@pytest.mark.asyncio
async def test_needs_approval_production(k8s_agent):
    """æµ‹è¯•å®¡æ‰¹æ£€æŸ¥ - ç”Ÿäº§ç¯å¢ƒ"""
    assert k8s_agent._needs_approval("get_pods", {"namespace": "production"}) == False
    assert k8s_agent._needs_approval("restart_deployment", {"namespace": "production"}) == True

@pytest.mark.asyncio
async def test_needs_approval_scale(k8s_agent):
    """æµ‹è¯•å®¡æ‰¹æ£€æŸ¥ - å¤§è§„æ¨¡æ‰©ç¼©å®¹"""
    assert k8s_agent._needs_approval("scale_deployment", {"namespace": "default", "replicas": 15}) == True
    assert k8s_agent._needs_approval("scale_deployment", {"namespace": "default", "replicas": 5}) == False

if __name__ == "__main__":
    pytest.main([__file__, "-v"])
EOF

# è¿è¡Œæµ‹è¯•
pip install pytest pytest-asyncio
pytest tests/test_k8s_agent.py -v
```

**é¢„æœŸè¾“å‡ºï¼š**
```
âœ… test_agent_initialization PASSED
âœ… test_validate_get_pods PASSED
âœ… test_validate_missing_namespace PASSED
âœ… test_validate_scale_deployment PASSED
âœ… test_needs_approval_production PASSED
âœ… test_needs_approval_scale PASSED
```

---

## æ­¥éª¤ 6: é›†æˆ NanoBot

### 6.1 å®‰è£… NanoBot

```bash
# å®‰è£… NanoBot
pip install nanobot-ai

# åˆå§‹åŒ–
nanobot onboard
```

### 6.2 é…ç½® NanoBot

```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim ~/.nanobot/config.json
```

æ·»åŠ é…ç½®ï¼š

```json
{
  "providers": {
    "dashscope": {
      "apiKey": "sk-your-api-key"
    }
  },
  "agents": {
    "defaults": {
      "model": "dashscope/qwen-max"
    }
  },
  "tools": {
    "mcpServers": {
      "k8s": {
        "command": "python",
        "args": ["-m", "sre_nanobot.mcp.k8s_server"],
        "cwd": "/home/ubuntu/.openclaw/workspace/sre-nanobot"
      }
    }
  }
}
```

### 6.3 æµ‹è¯•å¯¹è¯

```bash
# å¯åŠ¨ç½‘å…³ï¼ˆç»ˆç«¯ 1ï¼‰
nanobot gateway

# CLI æµ‹è¯•ï¼ˆç»ˆç«¯ 2ï¼‰
nanobot agent -m "æŸ¥çœ‹ default å‘½åç©ºé—´çš„ Pod"
```

---

## æ­¥éª¤ 7: åŠŸèƒ½éªŒè¯

### 7.1 éªŒè¯ MCP å·¥å…·

åˆ›å»ºæµ‹è¯•è„šæœ¬ï¼š

```bash
cat > tests/verify_mcp.py << 'EOF'
#!/usr/bin/env python3
"""
K8s MCP æœåŠ¡å™¨åŠŸèƒ½éªŒè¯
"""

import asyncio
import sys
from sre_nanobot.mcp.k8s_server import (
    list_tools,
    get_pods,
    get_deployments,
    get_nodes,
    restart_deployment,
    scale_deployment
)

async def verify_tools():
    """éªŒè¯å·¥å…·åˆ—è¡¨"""
    print("ğŸ“‹ éªŒè¯å·¥å…·åˆ—è¡¨...")
    tools = await list_tools()
    print(f"âœ… å…± {len(tools)} ä¸ªå·¥å…·")
    
    expected_tools = [
        "kubectl_get_pods",
        "kubectl_get_deployments",
        "kubectl_get_services",
        "kubectl_get_events",
        "kubectl_get_nodes",
        "kubectl_get_logs",
        "kubectl_describe_pod",
        "kubectl_describe_node",
        "kubectl_restart_deployment",
        "kubectl_scale_deployment",
        "kubectl_get_resource_usage"
    ]
    
    tool_names = [t.name for t in tools]
    for name in expected_tools:
        if name in tool_names:
            print(f"  âœ… {name}")
        else:
            print(f"  âŒ {name} (ç¼ºå¤±)")
    
    return tools

async def verify_functions():
    """éªŒè¯å‡½æ•°æ‰§è¡Œï¼ˆéœ€è¦ K8s é›†ç¾¤ï¼‰"""
    print("\nğŸ”§ éªŒè¯å‡½æ•°æ‰§è¡Œ...")
    
    try:
        # æµ‹è¯• get_nodes
        print("  æµ‹è¯• get_nodes...")
        result = await get_nodes({})
        print(f"  âœ… get_nodes: {len(result[0].text)} å­—èŠ‚")
    except Exception as e:
        print(f"  âš ï¸ get_nodes éœ€è¦ K8s é›†ç¾¤ï¼š{e}")
    
    try:
        # æµ‹è¯• get_pods
        print("  æµ‹è¯• get_pods...")
        result = await get_pods({"namespace": "default"})
        print(f"  âœ… get_pods: {len(result[0].text)} å­—èŠ‚")
    except Exception as e:
        print(f"  âš ï¸ get_pods éœ€è¦ K8s é›†ç¾¤ï¼š{e}")

async def main():
    print("=" * 50)
    print("K8s MCP æœåŠ¡å™¨åŠŸèƒ½éªŒè¯")
    print("=" * 50)
    
    await verify_tools()
    await verify_functions()
    
    print("\n" + "=" * 50)
    print("éªŒè¯å®Œæˆï¼")
    print("=" * 50)

if __name__ == "__main__":
    asyncio.run(main())
EOF

# è¿è¡ŒéªŒè¯
python tests/verify_mcp.py
```

**é¢„æœŸè¾“å‡ºï¼š**
```
==================================================
K8s MCP æœåŠ¡å™¨åŠŸèƒ½éªŒè¯
==================================================
ğŸ“‹ éªŒè¯å·¥å…·åˆ—è¡¨...
âœ… å…± 11 ä¸ªå·¥å…·
  âœ… kubectl_get_pods
  âœ… kubectl_get_deployments
  âœ… kubectl_get_services
  âœ… kubectl_get_events
  âœ… kubectl_get_nodes
  âœ… kubectl_get_logs
  âœ… kubectl_describe_pod
  âœ… kubectl_describe_node
  âœ… kubectl_restart_deployment
  âœ… kubectl_scale_deployment
  âœ… kubectl_get_resource_usage

ğŸ”§ éªŒè¯å‡½æ•°æ‰§è¡Œ...
  æµ‹è¯• get_nodes...
  âš ï¸ get_nodes éœ€è¦ K8s é›†ç¾¤ï¼škubectl å‘½ä»¤å¤±è´¥...

==================================================
éªŒè¯å®Œæˆï¼
==================================================
```

---

## ğŸ“Š éªŒè¯ç»“æœæ¨¡æ¿

### âœ… éªŒè¯é€šè¿‡ï¼ˆæœ‰ K8s ç¯å¢ƒï¼‰

```
âœ… é¡¹ç›®ç»“æ„å®Œæ•´
âœ… Python ä¾èµ–å®‰è£…æˆåŠŸ
âœ… kubectl å·²å®‰è£…
âœ… K8s é›†ç¾¤è¿æ¥æ­£å¸¸
âœ… MCP æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ
âœ… 11 ä¸ªå·¥å…·å…¨éƒ¨å¯ç”¨
âœ… Agent å•å…ƒæµ‹è¯•é€šè¿‡
âœ… NanoBot é›†æˆæˆåŠŸ

éªŒè¯ç»“æœï¼šé€šè¿‡ ğŸ‰
```

### âš ï¸ éƒ¨åˆ†é€šè¿‡ï¼ˆæ—  K8s ç¯å¢ƒï¼‰

```
âœ… é¡¹ç›®ç»“æ„å®Œæ•´
âœ… Python ä¾èµ–å®‰è£…æˆåŠŸ
âŒ kubectl æœªå®‰è£…ï¼ˆå¯é€‰ï¼‰
âŒ K8s é›†ç¾¤æœªè¿æ¥ï¼ˆå¯é€‰ï¼‰
âœ… MCP æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ
âœ… 11 ä¸ªå·¥å…·å®šä¹‰å®Œæ•´
âœ… Agent å•å…ƒæµ‹è¯•é€šè¿‡
â³ NanoBot é›†æˆå¾…æµ‹è¯•

éªŒè¯ç»“æœï¼šéƒ¨åˆ†é€šè¿‡ï¼ˆä»£ç å±‚é¢ï¼‰
å»ºè®®ï¼šå®‰è£… kubectl å¹¶è¿æ¥é›†ç¾¤è¿›è¡Œå®Œæ•´æµ‹è¯•
```

---

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜ 1: MCP æœåŠ¡å™¨æ— æ³•å¯åŠ¨

**é”™è¯¯ï¼š**
```
ModuleNotFoundError: No module named 'mcp'
```

**è§£å†³ï¼š**
```bash
pip install mcp
```

### é—®é¢˜ 2: kubectl æƒé™ä¸è¶³

**é”™è¯¯ï¼š**
```
Error from server (Forbidden): pods is forbidden
```

**è§£å†³ï¼š**
```bash
# æ£€æŸ¥æƒé™
kubectl auth can-i get pods -n default

# é…ç½®æ­£ç¡®çš„ kubeconfig
export KUBECONFIG=/path/to/kubeconfig
```

### é—®é¢˜ 3: NanoBot é…ç½®é”™è¯¯

**é”™è¯¯ï¼š**
```
Failed to load config
```

**è§£å†³ï¼š**
```bash
# éªŒè¯ JSON æ ¼å¼
python -c "import json; json.load(open('~/.nanobot/config.json'))"

# æ£€æŸ¥é…ç½®è·¯å¾„
ls -la ~/.nanobot/config.json
```

---

## ğŸ“ è·å–å¸®åŠ©

é‡åˆ°é—®é¢˜ï¼Ÿ

1. æŸ¥çœ‹æ—¥å¿—ï¼š
   ```bash
   # MCP æœåŠ¡å™¨æ—¥å¿—
   python -m sre_nanobot.mcp.k8s_server 2>&1 | tee mcp.log
   
   # NanoBot æ—¥å¿—
   nanobot logs
   ```

2. æäº¤ Issueï¼š
   - GitHub: https://github.com/your-org/sre-nanobot/issues

3. å†…éƒ¨æ”¯æŒï¼š
   - æ–‡æ¡£ï¼š./docs/é˜¶æ®µ 1-å®ŒæˆæŠ¥å‘Š.md

---

*éªŒè¯æŒ‡å—ç‰ˆæœ¬ï¼šv0.1.0*
*æœ€åæ›´æ–°ï¼š2026-02-26*
